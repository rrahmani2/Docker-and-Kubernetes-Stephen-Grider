**Synopsis: Building the Worker Service (Redis + Fibonacci Logic)**

---

### **1. Purpose of This Section**

* Start implementing the **JavaScript source code** for the multi-container Fibonacci application.
* Specifically focus on creating the **Worker process**, which handles background computation.
* **No Docker or deployment configuration** yet — this section is purely about backend logic.

---

### **2. What the Worker Does**

* The **Worker process** constantly monitors **Redis** for new indices submitted by users.
* When a new index appears:

  1. It pulls the index from Redis.
  2. Calculates the corresponding **Fibonacci number**.
  3. Stores the computed result back into Redis under a hash called `"values"`.

This isolates heavy computation from the API server (Express) to keep the backend responsive.

---

### **3. Project Setup Steps**

1. Create a new folder named **`complex`** for the project.
2. Inside it, make a subfolder **`worker/`** to hold the worker source code.
3. Inside `worker/`, create the following files:

   * `package.json`
   * `index.js`
   * `keys.js`

---

### **4. The `package.json` Configuration**

Defines dependencies and scripts:

```json
{
  "dependencies": {
    "nodemon": "1.18.3",
    "redis": "2.8.0"
  },
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon"
  }
}
```

**Notes:**

* Use **double quotes** everywhere.
* Ensure commas are correctly placed — trailing commas will break the file.
* `nodemon` is for live reloading during development.
* `redis` is the client library to interact with Redis from Node.js.

---

### **5. The `keys.js` File**

Stores connection details for Redis, pulled from environment variables:

```js
module.exports = {
  redisHost: process.env.REDIS_HOST,
  redisPort: process.env.REDIS_PORT
};
```

This makes the worker configurable and environment-agnostic.

---

### **6. The `index.js` File**

Implements:

* Redis client setup
* Fibonacci calculation
* Subscription to new messages (indices)

**Key parts:**

```js
const keys = require('./keys');
const redis = require('redis');

// Connect to Redis
const redisClient = redis.createClient({
  host: keys.redisHost,
  port: keys.redisPort,
  retry_strategy: () => 1000  // Reconnect every 1s if disconnected
});

// Duplicate connection for subscription
const sub = redisClient.duplicate();

// Fibonacci function (recursive, intentionally slow)
function fib(index) {
  if (index < 2) return 1;
  return fib(index - 1) + fib(index - 2);
}

// When a new message (index) arrives in Redis
sub.on('message', (channel, message) => {
  redisClient.hset('values', message, fib(parseInt(message)));
});

// Subscribe to 'insert' events in Redis
sub.subscribe('insert');
```

---

### **7. Testing for Syntax Errors**

Run the script manually (it won’t execute successfully yet but checks for typos):

```bash
cd worker
node index.js
```

If you see:

```
Error: Cannot find module 'redis'
```

→ That’s **expected** (since `redis` isn’t installed yet).

If you see any **syntax error messages**, it means there’s a **typo** in your code — go back and fix it before proceeding.

---

### **8. Summary**

At this point:

* You’ve created the **Worker** service that connects to Redis.
* It listens for new index insertions.
* Calculates Fibonacci numbers recursively.
* Stores the results back in Redis.

This Worker will later run inside its **own container** in Docker and communicate with the other services (Express API, Postgres, Nginx, React).

Next up: implementing the **API server (Express)** that interacts with this worker and the databases.
