**Synopsis: Building the Express Server – PostgreSQL Connection Setup**

---

### **1. Purpose of This Section**

This part continues the implementation of the **Express API server** (`index.js`) that will:

* Handle requests from the React frontend.
* Interact with both **Redis** and **PostgreSQL**.
* Serve as the API layer for submitting and retrieving Fibonacci data.

The focus here is on **Express setup** and **PostgreSQL integration** — Redis setup comes next.

---

### **2. Create and Configure `index.js`**

Inside the `server/` directory, create a new file named **`index.js`**.
This file will contain the entire backend logic for Express, PostgreSQL, and Redis.

---

### **3. Step 1 — Import Dependencies and Initialize Express**

At the top of the file:

```js
const keys = require('./keys');
const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors');

const app = express();

app.use(cors());
app.use(bodyParser.json());
```

#### **Explanation:**

* **`keys`** → Imports environment-based configuration for Redis and PostgreSQL.
* **`express`** → Framework for creating the API.
* **`body-parser`** → Parses incoming JSON request bodies (from React).
* **`cors`** → Allows cross-origin requests from the React frontend (different port/domain).
* `app.use(cors())` → Enables CORS globally.
* `app.use(bodyParser.json())` → Automatically parses JSON request payloads.

> ⚠️ You need to add `body-parser` to your dependencies since it was missing earlier.

Update your **`package.json`**:

```json
"dependencies": {
  "express": "4.16.3",
  "pg": "7.4.3",
  "redis": "2.8.0",
  "cors": "2.8.4",
  "nodemon": "1.18.3",
  "body-parser": "*"
}
```

---

### **4. Step 2 — PostgreSQL Client Setup**

Below your Express configuration, add:

```js
const { Pool } = require('pg');

const pgClient = new Pool({
  user: keys.pgUser,
  host: keys.pgHost,
  database: keys.pgDatabase,
  password: keys.pgPassword,
  port: keys.pgPort
});

pgClient.on('error', () => console.log('Lost PG connection'));
```

#### **Explanation:**

* **`Pool`** → Manages a set of connections to the Postgres server.
* Uses credentials from `keys.js`.
* Adds an error listener to log if the connection drops.

---

### **5. Step 3 — Create Table in PostgreSQL**

Immediately after defining the client:

```js
pgClient
  .query('CREATE TABLE IF NOT EXISTS values (number INT)')
  .catch(err => console.log(err));
```

#### **Explanation:**

* Creates a table named **`values`** if it doesn’t already exist.
* The table stores one column, `number`, representing the submitted Fibonacci index.
* Any SQL or connection error will be logged for debugging.

---

### **6. Summary of What’s Implemented**

✅ Express app initialized and configured with `CORS` + `body-parser`.
✅ PostgreSQL connection established using environment-based credentials.
✅ Automatic table creation for storing submitted Fibonacci indices.

---

### **7. Next Step**

In the next section, you’ll:

* Add **Redis connection logic** to the same `index.js` file.
* Complete the server’s ability to handle incoming Fibonacci calculations.
* Begin wiring up API routes for the frontend to submit and retrieve data.
