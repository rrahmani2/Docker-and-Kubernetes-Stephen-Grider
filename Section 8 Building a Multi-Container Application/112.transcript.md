**Synopsis: Completing the Express Server – Redis Integration and Route Handlers**

---

### **1. Purpose of This Section**

This section completes the **Express server setup** by:

* Connecting it to **Redis** (for temporary Fibonacci values).
* Implementing **all Express routes** that interact with both Redis and PostgreSQL.
* Finalizing the server’s configuration to respond to frontend requests.

---

### **2. Step 1 — Redis Client Setup**

Add this section **below the PostgreSQL setup** in `index.js`:

```js
const redis = require('redis');

const redisClient = redis.createClient({
  host: keys.redisHost,
  port: keys.redisPort,
  retry_strategy: () => 1000
});

const redisPublisher = redisClient.duplicate();
```

#### **Explanation:**

* **`redis.createClient()`**: Creates a Redis connection using host and port from environment variables.
* **`retry_strategy`**: Ensures the client attempts reconnection every 1 second if disconnected.
* **`duplicate()`**: Creates a second Redis connection dedicated to publishing messages — required because a single Redis connection cannot handle both data operations and pub/sub simultaneously.

---

### **3. Step 2 — Define Express Route Handlers**

Below the Redis setup, start defining your API routes.

#### **A. Test Route**

```js
app.get('/', (req, res) => {
  res.send('Hi');
});
```

Used to confirm that the server is responding.

---

#### **B. Retrieve All Submitted Values (Postgres)**

```js
app.get('/values/all', async (req, res) => {
  const values = await pgClient.query('SELECT * FROM values');
  res.send(values.rows);
});
```

* Queries PostgreSQL for all stored indices.
* Returns all records from the `values` table.

---

#### **C. Retrieve Current Calculated Values (Redis)**

```js
app.get('/values/current', async (req, res) => {
  redisClient.hgetall('values', (err, values) => {
    res.send(values);
  });
});
```

* Fetches the current Fibonacci results stored in Redis.
* Uses callbacks since the Redis client doesn’t natively support Promises.

---

#### **D. Handle New Value Submission (POST Request)**

```js
app.post('/values', async (req, res) => {
  const index = req.body.index;

  if (parseInt(index) > 40) {
    return res.status(422).send('Index too high');
  }

  redisClient.hset('values', index, 'Nothing yet!');
  redisPublisher.publish('insert', index);
  pgClient.query('INSERT INTO values(number) VALUES($1)', [index]);

  res.send({ working: true });
});
```

#### **Explanation:**

* **Input Validation:** Rejects large indices (`> 40`) to prevent excessive Fibonacci calculations.
* **Redis Operations:**

  * Adds a placeholder entry (`"Nothing yet!"`) in the Redis `values` hash.
  * Publishes an `"insert"` event to trigger the worker process for calculation.
* **Postgres Operation:**

  * Permanently records the submitted index in the database.
* **Response:** Sends confirmation that work has started.

---

### **4. Step 3 — Start the Express Server**

At the bottom of `index.js`, add:

```js
app.listen(5000, err => {
  console.log('Listening on port 5000');
});
```

---

### **5. Step 4 — Test the Setup**

To verify syntax and dependencies (even though Redis and Postgres aren’t running yet):

```bash
cd server
node index.js
```

Expected output:

```
Error: Cannot find module 'express'
```

→ This indicates dependencies need installation — not a typo in your source.

If you see **any other error**, recheck:

* `keys.js` variable names.
* Typing in Redis/PG configuration blocks.

---

### **6. Summary of What’s Complete**

✅ Connected Express server to both **PostgreSQL** and **Redis**.
✅ Implemented routes for:

* Testing server availability.
* Fetching stored and calculated Fibonacci data.
* Accepting new Fibonacci computation requests.
  ✅ Added logic to safely cap Fibonacci calculations (`index ≤ 40`).
  ✅ Fully configured the backend API to integrate with the React frontend.

---

### **7. Next Step**

Next, you’ll move on to the **React frontend** — building the interface that:

* Submits numbers to the backend.
* Displays all past submissions and current Fibonacci results.
